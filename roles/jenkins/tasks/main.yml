- name: Create tmp jenkins directory
  file: path=/tmp/jenkins state=directory mode=0777

- name: Copy jenkins dockerfile
  template: src=Dockerfile dest=/tmp/jenkins/Dockerfile force=yes

- name: Create the jenkins container image
  docker_image:
    path: /tmp/jenkins
    name: biblicando/jenkins
    state: present
    tag: latest
    push: no

- name: Create a jenkins data container
  docker_container:
    name: jenkins_home
    image: alpine
    state: present
    entrypoint: /bin/true
    volumes:
      - "/var/jenkins_home"

- name: Create a Jenkins container
  docker_container:
    name: jenkins
    image: biblicando/jenkins
    state: started
    restart: no
    volumes_from:
      - jenkins_home
    ports:
      - "8080:{{ jenkins_http_port }}"
      - "50000:50000"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"

- name: Print initial admin password
  command: docker run --rm --volumes-from jenkins_home alpine cat /var/jenkins_home/secrets/initialAdminPassword
  register: initial_jenkins_password

- name: Print initial admin password
  debug: msg="Initial admin password is {{ initial_jenkins_password.stdout }}"